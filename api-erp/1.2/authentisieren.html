<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: gematik API</title>
    <link rel="canonical" href="https://spilikin.dev/api-tools/api-erp/1.2/authentisieren.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://spilikin.dev/api-tools">gematik API</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://github.com/gematik/"><img style="height: 1.4em;margin-right: 0.4em;" src="../../_/img/github-mark-white.svg"> GiHub</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/gematik/api-telematik">Telematik API</a>
            <a class="navbar-item" href="https://github.com/gematik/api-erp">eRP API</a>
            <a class="navbar-item" href="https://github.com/gematik/api-epa">ePA API</a>
            <a class="navbar-item" href="https://github.com/gematik/api-kim/">KIM API</a>
            <a class="navbar-item" href="https://github.com/gematik/api-ti-messenger/">TI-Messenger API</a>
            <a class="navbar-item" href="https://github.com/gematik/api-vzd/">Directory API</a>
          </div>
        </div>
        <a class="navbar-item" href="https://fachportal.gematik.de/">Fachportal</a>
        <div class="navbar-item" style="scale: 1;">
          <span class="control">
            <img class="logo" src="../../_/img/gematik_logo_text.svg">
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="api-erp" data-version="1.2">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">ePrescription API</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">index.adoc</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ePrescription API</span>
    <span class="version">1.2</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">ePrescription API</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.2</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../api-directory-fhir/1.0.0/index.html">FHIR Directory API</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../api-directory-fhir/1.0.0/index.html">1.0.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../api-directory-ldap/1.7.0/index.html">LDAP Directory API</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../api-directory-ldap/1.7.0/index.html">1.7.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../api-telematik/5.5.0/overview/index.html">Telematik API</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../api-telematik/5.5.0/overview/index.html">5.5.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../api-ti-messenger/1.1.0/index.html">TI-Messenger API</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../api-ti-messenger/1.1.0/index.html">1.1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../api-telematik/5.5.0/overview/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/spilikin/poc-api-telematik/edit/erp/src/antora/modules/ROOT/pages/authentisieren.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="paragraph">
<p><span class="image"><img src="_images/gematik_logo.png" alt="gematik logo" width="35%"></span></p>
</div>
<div class="sect1">
<h2 id="_e_rezept_api_dokumentation"><a class="anchor" href="#_e_rezept_api_dokumentation"></a>E-Rezept API-Dokumentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hier dokumentiert die gematik die Nutzung der Schnittstellen, um sich mit der Telematikinfrastruktur zu verbinden. Das betrifft zum einen die Authentifizierung als Nutzer oder Institution durch den Identity Provider (IDP) und zum anderen den verschlüsselten Datentransport auf Anwendungsebene (<a href="#anchor-vau-transport">"VAU-Transport</a>").</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_http_header_in_requests_an_dienste_der_telematikinfrastruktur"><a class="anchor" href="#_http_header_in_requests_an_dienste_der_telematikinfrastruktur"></a>Http-Header in Requests an Dienste der Telematikinfrastruktur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Zur Steuerung der Funktionsaufrufe, für Sicherheitsprüfungen und die Protokollierung sind verpflichtende http-Header in allen http-Requests an den IDP-Dienst und den E-Rezept-Fachdienst erforderlich. Da mit dem VAU-Transport ein "innerer" und ein "äußerer" http-Request an den E-Rezept-Fachdienst gesendet werden, ist auf das korrekte Setzen innen und außen zu achten. Die folgende Tabelle listet die notwendigen http-Header auf.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 60%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-right valign-top">http-Header</th>
<th class="tableblock halign-center valign-top">äußerer Request ("/VAU")</th>
<th class="tableblock halign-center valign-top">innerer Request</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">Authorization</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">User-Agent</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">optional</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">X-erp-user</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">X-erp-resource</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">X-AccessCode</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">SOAPAction (nur für Konnektor)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">x</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Die Standard http-Header wie bspw. <code>Accept-*</code>, <code>Connection</code>, <code>Host</code>, <code>Content-Type</code>, <code>Content-Length</code> usw. sind gemäß Standard ebenfalls zu setzen.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_als_nutzer_der_telematikinfrastruktur_authentifiziert_werden"><a class="anchor" href="#_als_nutzer_der_telematikinfrastruktur_authentifiziert_werden"></a>Als Nutzer der Telematikinfrastruktur authentifiziert werden</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die Telematikinfrastruktur gestattet keinen Zugriff auf Dienste ohne eine Identifikation der Nutzer. Dies dient der Durchsetzung von Zugriffsregeln und der Protokollierung des Zugriffs auf medizinische Daten von Versicherten. Mit der Authentifizierung der Nutzer erfolgt keine Profilbildung, Sessiondaten werden temporär verwaltet und nach Beendigung einer Sesssion unverzüglich gelöscht. Die Protokollierung von Zugriffen auf medizinische Daten erfolgt in Abhängigkeit der genutzten Schnittstellen in den jeweils aufgerufenen Services sowie in Abhängigkeit der fachlichen Anforderungen gemäß gematik-Spezifikationen.<br></p>
</div>
<div class="paragraph">
<p>Die Authentifizierung übernimmt mit der Einführung des E-Rezepts ein zentraler Identity Provider (IDP). Der IDP erkennt Nutzer anhand ihrer kartenbasierten Identitäten und stellt die Identitätsmerkmale (Name, KVNR bzw. Telematik-ID) der Zertifikate auf der Karte in ID_TOKEN und ACCESS_TOKEN für die Nutzung im E-Rezept-Fachdienst bereit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ablauf_des_authentifizierungsprotokolls"><a class="anchor" href="#_ablauf_des_authentifizierungsprotokolls"></a>Ablauf des Authentifizierungsprotokolls</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Leistungserbringerinstitutionen (Praxen, Apotheken, Krankenhäuser) weisen sich gegenüber der Telematikinfrastruktur mit der Identität des Praxisausweises SMC-B aus. Die Authentifizierung erfolgt gegenüber dem Identity Provider (IDP) unter Nutzung der Konnektorschnittstelle.</p>
</div>
<div class="paragraph">
<p>Das Primärsystem adressiert Anfragen an den IDP über eine bekannt zu machende Adresse <strong>z.B.</strong> <code>idp.zentral.idp.splitdns.ti-dienste.de</code> bzw. <code>idp.app.ti-dienste.de</code>, dabei veröffentlicht der IDP sein DiscoveryDocument mit den Informationen zu verschiedenen Endpunkten zur Tokenausstellung unter einer "/.well-known"-Adresse, d.h. <code>idp.ti-dienste.de/.well-known/openid-configuration</code>.</p>
</div>
<div class="paragraph">
<p>Die folgende Abbildung zeigt den detaillierten Ablauf mit allen beteiligten Komponenten. Das Primärsystem gliedert sich in die E-Rezept-Fachlogik und ein Authenticator-Modul. Letzteres übernimmt die Authentisierung mittels der kartenbasierten Identität unter Nutzung der Konnektorschnittstellen. Der IDP authentifiziert den Nutzer anhand der kartenbasierten Identität und einer Signatur durch das Schlüsselmaterial auf der Karte (SMC-B) und stellt bei Erfolg einen Zugriffstoken (ACCESS_TOKEN) für den Zugriff auf den Fachdienst aus.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/workflowAuthentication.svg" alt="workflowAuthentication" width="100%"></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Die Ablaufbeschreibung <a href="https://gematik.github.io/ref-idp-server/tokenFlowPs.html" target="_blank" rel="noopener">Rbelflow für Primärsysteme</a> gibt ein konkretes Beispiel mit Request- und Response-Parametern für die Authentifizierung mittels SMC-B einer Test-Apotheke "3-SMC-B-Testkarte-883110000xxxxxx" (siehe auch "professionOID": "1.2.276.0.76.4.54" = "Öffentliche Apotheke").
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Die folgenden Schritte sind von besonderer Bedeutung und werden kurz erläutert.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 0.9803%;">
<col style="width: 0.9803%;">
<col style="width: 98.0394%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Step</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>eRp (Fachlogik) / AM (Auth-Modul)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beschreibung</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 - 5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM/eRP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Laden des Discovery Documents (DD) vom IDP (Diese Operation wird vorbereitend sowohl vom Auth-Modul, wie auch von der Fachlogik und dem Fachdienst durchgeführt)<br>
 [<a href="https://idp.zentral.idp.splitdns.ti-dienste.de/.well-known/openid-configuration" class="bare">https://idp.zentral.idp.splitdns.ti-dienste.de/.well-known/openid-configuration</a>] <strong>Schritt 1 im Rbel-Flow</strong>,
Prüfung der Signatur des DD gegen das Signatur-Zertifikat im <code>x5c</code>-Feld des Response-Header und Verifikation des Zertifikates gegen den Vertrauensraum der TI und eine Prüfung der technischen Rolle (siehe unten <a href="#anchor-verify-certificate">Konnektor-Aufruf</a>,</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 - 8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eRp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Erzeugung eines CODE_VERIFIER (128 zufällige Zeichen aus der Menge [A-Z] / [a-z] / [0-9] / "-" / "." / "_" / "~") und bilden der CODE_CHALLENGE als dessen sha256-Hashwert sowie,
Erzeugung einer <code>nonce</code> und eines <code>state</code>. <code>Nonce</code> ist ein optionaler Zufallswert, <code>state</code> kann beliebig gewählt werden, also ebenso eine Zufallszahl oder eine session-id etc.<br>
 Um das CHALLENGE_TOKEN zu beziehen, werden CODE_CHALLENGE, <code>state</code> und ggf. <code>Nonce</code> an das Authenticator-Modul übergeben und in der Fachlogik für spätere Prüfungen zwischengespeichert.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="3"><p class="tableblock"><strong>AuthorizationCode über Handshake mit Kartenidentität beziehen</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9 - 12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lesen des X509-Signatur-Zertifikats zum <code>puk_idp_sig</code> des IDP und des IDP-Verschlüsselungsschlüssels <code>puk_idp_enc</code> von <a href="http://url.des.idp/idpSig/jwk.json" class="bare">http://url.des.idp/idpSig/jwk.json</a> und <a href="http://url.des.idp/idpEnc/jwk.json" class="bare">http://url.des.idp/idpEnc/jwk.json</a> oder aus dem JWK-Set <a href="http://url.des.idp/jwks" class="bare">http://url.des.idp/jwks</a> <strong>Schritt 3 + 5 im Rbel-Flow</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">13 - 17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Senden der in Schritt 8 übergebenen Werte (als URL-Parameter wie z.B. 'code_challenge') an den authorization_endpoint des IDP, ,+ dieser antwortet mit dem CHALLENGE_TOKEN und dem <code>user_consent</code> <strong>Schritt 7 im Rbel-Flow</strong>,<br>
Die Signatur des CHALLENGE_TOKEN wird mittels <code>puk_idp_sig</code> geprüft. Es erfolgt eine Verifikation des Zertifikates gegen den Vertrauensraum der TI und eine Prüfung der technischen Rolle (siehe unten <a href="#anchor-verify-certificate">Konnektor-Aufruf</a>,.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18 - 19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anzeige des <code>user_consent</code> und Bestätigung durch den Nutzer, dass die genannten personenbezogenen Attribute vom IDP verarbeitet und dem Fachdienst übermittelt werden dürfen.
Die erfolgte Nutzereinwilligung für diesen <code>scope</code> kann gespeichert werden.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zertifikat der Authentisierungs-Identität C.HCI.AUT von der SMC-B lesen (siehe unten <a href="#anchor-read-aut">Konnektor-Aufruf</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Berechnen des HASH-Werts der empfangenen Challenge und Signieren des Challenge-HASH mit PrK.HCI.AUT der SMC-B (siehe unten <a href="#anchor-sign-challenge">Konnektor-Aufruf</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWE-Verschlüsselung der signierten Challenge als njwt und des Zertifikats C.HCI.AUT mit <code>puk_idp_enc</code> aus dem Discovery Document.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">23 - 27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Senden der verschlüsselten Challenge und des verschlüsselten Zertifikats an den authorization_endpoint des IDP<br>
<strong>Schritt 9 im Rbel-Flow</strong><br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Die Response (<code>AuthorizationCode</code> und Redirect zum Tausch des <code>AuthorizationCode</code> gegen einen ACCESS_TOKEN) wird an die Fachlogik zurückgegeben.<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="3"><p class="tableblock"><strong>Authentifizierung des Nutzers abgeschlossen, im Folgenden wird der ACCESS_TOKEN für den Zugriff am E-Rezept-Fachdienst mit Hilfe des AuthorizationCodes abgerufen.</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">29 - 32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eRp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generierung eines <code>Token-Key</code> (AES256) zur verschlüsselten Kommunikation mit dem IDP, anschließend wird dem Redirect gefolgt, um den <code>AuthorizationCode</code> gegen ein AccessToken zu tauschen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">33 - 37</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eRp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Aufruf übergibt den zuvor erhaltenen <code>AuthorizationCode</code> und den zusammen mit dem CODE_VERIFIER verschlüsselten <code>Token-Key</code>.<br>
<strong>Schritt 11 im Rbel-Flow</strong><br>
Der IDP prüft die Signatur des <code>AuthorizationCode</code>, um die Gültigkeit des Codes zu verifizieren und antwortet mit einem verschlüsselten AccessToken für den Zugriff auf den E-Rezept-Fachdienst und mit einem verschlüsselten ID_TOKEN.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">38 - 41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eRp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Das ACCESS_TOKEN und das ID_TOKEN werden mit Hilfe des <code>Token-Key</code> entschlüsselt. Die Signatur des ID_TOKEN wird gegen den <code>puk_idp_sig</code> überprüft. Es erfolgt eine Verifikation des Zertifikates gegen den Vertrauensraum der TI und eine Prüfung der technischen Rolle (siehe unten <a href="#anchor-verify-certificate">Konnektor-Aufruf</a>,.
Die enthaltene Nonce gegen den im Schritt 1 erzeugten Wert abgeglichen. Anschließend wird das ACCESS_TOKEN zum Zugriff auf den Fachdienst verwendet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">42 - 44</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Fachdienst prüft die Signatur des ACCESS_TOKEN, liest die dem Scope zugewiesenen Claims und gibt dem identifizierten Benutzer Zugriff auf die Fachdaten der Anwendung.</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_vorbereitende_schritte_für_die_authentifizierung_mittels_der_smc_b"><a class="anchor" href="#_vorbereitende_schritte_für_die_authentifizierung_mittels_der_smc_b"></a>Vorbereitende Schritte für die Authentifizierung mittels der SMC-B</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Dem Nutzer soll der vom IDP bereitgestellte UserConsent angezeigt werden. Stimmt der Nutzer der Bereitstellung der Daten für den E-Rezept-Fachdienst nicht zu, muss der Authentifizierungsvorgang abgebrochen werden, da der Fachdienst ohne diese Informationen den E-Rezept-Workflow nicht umsetzen kann.</p>
</li>
<li>
<p>Die vom IDP in der obigen Response übermittelte Challenge beinhaltet ein Challenge-Token <code>{"iss":"https://idp.zentral.idp.splitdns.ti-dienste.de","response_type":"code","snc":"syQAvJmxPnRtLjT6uPVERb_RF7MmVzhS1sP8FbHjhLM","code_challenge_method":"S256","token_type":"challenge","nonce":"887766","client_id":"gematikTestPs","scope":"openid e-rezept","state":"xxxstatexxx","redirect_uri":"http://test-ps.gematik.de/erezept","exp":1616686048,"iat":1616685868,"code_challenge":"Ca3Ve8jSsBQOBFVqQvLs1E-dGV1BXg2FTvrd-Tg19Vg","jti":"5e5ad23ae3e7d8aa"}</code> in Base64-Codierung <code>eyJpc3MiOiJodHRwczovL2lkcC56ZW50cmFsLmlkcC5zcGxpdGRucy50aS1kaWVuc3RlLmRlIiwicmVzcG9uc2VfdHlwZSI6ImNvZGUiLCJzbmMiOiJzeVFBdkpteFBuUnRMalQ2dVBWRVJiX1JGN01tVnpoUzFzUDhGYkhqaExNIiwiY29kZV9jaGFsbGVuZ2VfbWV0aG9kIjoiUzI1NiIsInRva2VuX3R5cGUiOiJjaGFsbGVuZ2UiLCJub25jZSI6Ijg4Nzc2NiIsImNsaWVudF9pZCI6ImdlbWF0aWtUZXN0UHMiLCJzY29wZSI6Im9wZW5pZCBlLXJlemVwdCIsInN0YXRlIjoieHh4c3RhdGV4eHgiLCJyZWRpcmVjdF91cmkiOiJodHRwOi8vdGVzdC1wcy5nZW1hdGlrLmRlL2VyZXplcHQiLCJleHAiOjE2MTY2ODYwNDgsImlhdCI6MTYxNjY4NTg2OCwiY29kZV9jaGFsbGVuZ2UiOiJDYTNWZThqU3NCUU9CRlZxUXZMczFFLWRHVjFCWGcyRlR2cmQtVGcxOVZnIiwianRpIjoiNWU1YWQyM2FlM2U3ZDhhYSJ9</code>. Da die Signatur immer über einen Hashwert der zu signierenden Daten erfolgt, muss dieser Hashwert vom Clientsystem berechnet werden. Als kryptografisches Verfahren kommt hier SHA-256 zum Einsatz. Aus dem obigen Beispiel <code>eyJpc3MiOiJodHRwczovL2lkcC56ZW50cmFsLmlkcC5&#8230;&#8203;</code> ergibt sich folgender Hashwert: <code>dd775a30757431a62bbe12301898511f5d9d5145a58dbd5d6cbae2481b36993f</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="anchor-read-aut"><a class="anchor" href="#anchor-read-aut"></a>Request zum Auslesen des Zertifikats der SMC-B über Konnektor (read_certificate)</h3>
<div class="paragraph">
<p>Der Konnektor authentifiziert Nutzer anhand einer kartengebundenen, kryptografischen Identität. Die Karte hält den privaten Schlüssel zu dieser Identität, welcher für die Signatur über eine Challenge des IDP genutzt wird. Zur Prüfung der Signatur benötigt der IDP das Zertifikat dieser Identität. Dieses enthält den öffentlichen Schlüssel für die kryptografische Signaturprüfung sowie weitere Nutzerinformationen (Name, KVNR/Telematik-ID, fachliche Rolle), die der IDP in Identitätsbestätigungen zur Nutzung gegenüber dem E-Rezept-Fachdienst attestiert. Der Abruf des Zertifikats erfolgt über die Konnektor-Operation <code>ReadCertificate</code>.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">URI</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="https://192.168.x.y/Konnektorservice" class="bare">https://192.168.x.y/Konnektorservice</a></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Method</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>POST</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">HTTP Header</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>Content-Type: text/xml; charset=UTF-8
Content-Length: 1234
SOAPAction: "http://ws.gematik.de/conn/CertificateService/v7.4#ReadCardCertificate"</pre>
</div>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Payload</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;S:Envelope xmlns:S="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;S:Body&gt;
        &lt;ns8:ReadCardCertificate xmlns:ns2="http://ws.gematik.de/conn/CertificateServiceCommon/v2.0"
            xmlns:ns3="urn:oasis:names:tc:dss:1.0:core:schema"
            xmlns:ns4="http://www.w3.org/2000/09/xmldsig#"
            xmlns:ns5="http://ws.gematik.de/conn/ConnectorCommon/v5.0"
            xmlns:ns6="http://ws.gematik.de/tel/error/v2.0"
            xmlns:ns7="urn:oasis:names:tc:SAML:1.0:assertion"
            xmlns:ns8="http://ws.gematik.de/conn/CertificateService/v7.4"
            xmlns:ns9="http://ws.gematik.de/conn/ConnectorContext/v2.0"&gt;
            &lt;ns5:CardHandle&gt;smc-b_2&lt;/ns5:CardHandle&gt;
            &lt;ns9:Context&gt;
                &lt;ns5:MandantId&gt;Mandant1&lt;/ns5:MandantId&gt;
                &lt;ns5:ClientSystemId&gt;myPVS&lt;/ns5:ClientSystemId&gt;
                &lt;ns5:WorkplaceId&gt;WP1&lt;/ns5:WorkplaceId&gt;
            &lt;/ns9:Context&gt;
            &lt;ns8:CertRefList&gt;
                &lt;ns8:CertRef&gt;C.AUT&lt;/ns8:CertRef&gt;
            &lt;/ns8:CertRefList&gt;
        &lt;/ns8:ReadCardCertificate&gt;
    &lt;/S:Body&gt;
&lt;/S:Envelope&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
In <code>&lt;ns8:CertRef&gt;C.AUT&lt;/ns8:CertRef&gt;</code> wird angegeben, dass das Zertifikat zur Authentisierung gegenüber dem IDP aus der SMC-B ausgelesen werden soll.
</td>
</tr>
</table>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Response</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">HTTP/1.1 200 OK
Content-Type: text/xml;charset=utf-8

&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;soap:Body&gt;
        &lt;ns3:ReadCardCertificateResponse xmlns="http://ws.gematik.de/conn/ConnectorCommon/v5.0"
            xmlns:ns2="http://ws.gematik.de/conn/ConnectorContext/v2.0"
            xmlns:ns3="http://ws.gematik.de/conn/CertificateService/v7.4"
            xmlns:ns4="http://ws.gematik.de/tel/error/v2.0"
            xmlns:ns5="http://ws.gematik.de/conn/CertificateServiceCommon/v2.0"
            xmlns:ns6="http://www.w3.org/2000/09/xmldsig#"
            xmlns:ns7="urn:oasis:names:tc:dss:1.0:core:schema"
            xmlns:ns8="urn:oasis:names:tc:SAML:1.0:assertion"&gt;
            &lt;Status&gt;
                &lt;Result&gt;OK&lt;/Result&gt;
            &lt;/Status&gt;
            &lt;ns5:X509DataInfoList&gt;
                &lt;ns5:X509DataInfo&gt;
                    &lt;ns5:X509Data&gt;
                        &lt;ns5:X509Certificate&gt;MIIFcTCCBFmgAwIBAgIHAXumDkbX3zANBgkqhkiG9w0BAQsFADCBmjELMAkGA1UEBhMCREUxHzAdBgNVBAoMFmdlbWF0aWsgR21iSCBOT1QtVkFMSUQxSDBGBgNVBAsMP0luc3RpdHV0aW9uIGRlcyBHZXN1bmRoZWl0c3dlc2Vucy1DQSBkZXIgVGVsZW1hdGlraW5mcmFzdHJ1a3R1cjEgMB4GA1UEAwwXR0VNLlNNQ0ItQ0EyNCBURVNULU9OTFkwHhcNMjAwNjEwMDAwMDAwWhcNMjUwNjA5MjM1OTU5WjCB+DELMAkGA1UEBhMCREUxFDASBgNVBAcMC03DvGhsaGF1c2VuMQ4wDAYDVQQRDAU5OTk3NDEeMBwGA1UECQwVTGFuZ2Vuc2FsemFlciBTdHIuIDI1MSowKAYDVQQKDCEzLVNNQy1CLVRlc3RrYXJ0ZS04ODMxMTAwMDAxMjkwNjgxHTAbBgNVBAUTFDgwMjc2ODgzMTEwMDAwMTI5MDY4MRQwEgYDVQQEDAtCbGFua2VuYmVyZzEWMBQGA1UEKgwNRG9taW5pay1QZXRlcjEqMCgGA1UEAwwhQXBvdGhla2UgYW0gU3BvcnR6ZW50cnVtVEVTVC1PTkxZMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjVMEf2TTXlfkuCDyiMpo96jA5XRvkaHTy+4qTcDR1awUP4yemfKsB1BTWMMSDrA1/2YdnlZJeynEnQi0K4LWMvTcq+CRGi4ghcIokb2TURZXZ1K6FTJHqITojp9ZRaNTap+kIpOZCmSRa7ftRzEgooPjG6C+7XxUViczlVE17UJMPavWQfY2+A1M/0vx9Jbi7wPmXCMuEvj7yEAVRCGQExVxzbLZPE7FS/vlXcwkFtmnMUVWiQFFXlVLG7uUc9CQFvTXPT5ppDhxAmVeUBLNXKruDkpSeuq3sCi93ln9hXXw/xPeNAAehtvxFp6eMGf5LEVGvZj8v51qu4eDPaKtJwIDAQABo4IBWjCCAVYwEwYDVR0lBAwwCgYIKwYBBQUHAwIwDgYDVR0PAQH/BAQDAgWgMB0GA1UdDgQWBBSEkJ1lgmhiHfVZyKKyVw2Qd86PPDA4BggrBgEFBQcBAQQsMCowKAYIKwYBBQUHMAGGHGh0dHA6Ly9laGNhLmdlbWF0aWsuZGUvb2NzcC8wDAYDVR0TAQH/BAIwADAgBgNVHSAEGTAXMAoGCCqCFABMBIEjMAkGByqCFABMBE0wHwYDVR0jBBgwFoAUeunhb+oUWRYF7gPp0/0hq97p2Z4wgYQGBSskCAMDBHsweaQoMCYxCzAJBgNVBAYTAkRFMRcwFQYDVQQKDA5nZW1hdGlrIEJlcmxpbjBNMEswSTBHMBcMFcOWZmZlbnRsaWNoZSBBcG90aGVrZTAJBgcqghQATAQ2EyEzLVNNQy1CLVRlc3RrYXJ0ZS04ODMxMTAwMDAxMjkwNjgwDQYJKoZIhvcNAQELBQADggEBAGwmbkXMdRrIZwTzUVsdH6RUB7cc3+CcDN0NqLSOM7sdCQrr5NfzcK2dzhc77KVzviZbvz6MxfEq47Y/dPMmtVlU0Amw5bbnYT4WnadjrLOHnKCxLFssrfo0izB7IJvBswMQl/KnUXbk/X57KcNKTYOfuCVVVt+yET63N4qp9YOPiMdCHxu+BUvgwmOgr/enRnh+HgCYVQtzLmDXimBcneRoZg3XgukoMQPd5TlVlZAF1JZ6W8uGN+LEiddnHdzYFVInest3xMzwHj4T3lXLCkr6oc9jvwKe2A2qsBvcbEFDR0mi0CW9NjfJ05v/52GKZZZyjEnFjnHJ1J5r1DlD5S8=
                        &lt;/ns5:X509Certificate&gt;
                    &lt;/ns5:X509Data&gt;
                &lt;/ns5:X509DataInfo&gt;
            &lt;/ns5:X509DataInfoList&gt;
        &lt;/ns3:ReadCardCertificateResponse&gt;
    &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Der Konnektor liefert das Zertifikat in <code>&lt;ns5:X509Certificate&gt;</code> zurück, wie es auf der Karte gespeichert ist, ASN.1 DER codiert in Base64-Darstellung.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Code</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Type Success</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>200</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>OK<br>
<span class="small">Die Anfrage wurde erfolgreich bearbeitet.</span></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Code</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Type Error</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>400</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Bad Request <br>
<span class="small">Die Anfrage-Nachricht war fehlerhaft aufgebaut.</span></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="anchor-verify-certificate"><a class="anchor" href="#anchor-verify-certificate"></a>Zertifikat mittels Konnektoroperation verifizieren (verifyCertificate)</h3>
<div class="paragraph">
<p>Der Konnektor prüft das übergebene Zertifikat gegen den Vertrauensraum der Telematikinfrastruktur, dabei führt er eine Online-Prüfung des Sperrstatus durch und liefert das Ergebnis der Prüfung sowie die im Zertifikat enthaltene technische Rolle.
Diese technische Rolle muss das Primärsystem im Anschluß gegen die Rolle des erwarteten Dienstes abgleichen.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">URI</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="https://192.168.x.y/Konnektorservice" class="bare">https://192.168.x.y/Konnektorservice</a></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Method</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>POST</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">HTTP Header</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>Content-Type: text/xml; charset=UTF-8
Content-Length: 1234
SOAPAction: "http://ws.gematik.de/conn/CertificateService/v6.0#VerifyCertificate"</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title=":heavy_exclamation_mark:"></i>
</td>
<td class="content">
Die Länge des Soap-Requests, muss entsprechend im Header mit der Eigenschaft <code>Content-Length</code> gesetzt werden.
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Payload</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:m0="http://ws.gematik.de/conn/ConnectorContext/v2.0"
    xmlns:m1="http://ws.gematik.de/conn/ConnectorCommon/v5.0"
    xmlns:m2="http://ws.gematik.de/conn/CertificateServiceCommon/v2.0"&gt;
    &lt;SOAP-ENV:Body&gt;
        &lt;m:VerifyCertificate xmlns:m="http://ws.gematik.de/conn/CertificateService/v6.0"&gt;
            &lt;m0:Context&gt;
                &lt;m1:MandantId&gt;Mandant1&lt;/m1:MandantId&gt;
                &lt;m1:ClientSystemId&gt;ClientID1&lt;/m1:ClientSystemId&gt;
                &lt;m1:WorkplaceId&gt;CATS&lt;/m1:WorkplaceId&gt;
            &lt;/m0:Context&gt;
            &lt;m2:X509Certificate&gt;MIICsTCCAligAwIBAgIHA61I5ACUjTAKBggqhkjOPQQDAjCBhDELMAkGA1UEBhMCREUxHzAdBgNV
BAoMFmdlbWF0aWsgR21iSCBOT1QtVkFMSUQxMjAwBgNVBAsMKUtvbXBvbmVudGVuLUNBIGRlciBU
ZWxlbWF0aWtpbmZyYXN0cnVrdHVyMSAwHgYDVQQDDBdHRU0uS09NUC1DQTEwIFRFU1QtT05MWTAe
Fw0yMDA4MDQwMDAwMDBaFw0yNTA4MDQyMzU5NTlaMEkxCzAJBgNVBAYTAkRFMSYwJAYDVQQKDB1n
ZW1hdGlrIFRFU1QtT05MWSAtIE5PVC1WQUxJRDESMBAGA1UEAwwJSURQIFNpZyAxMFowFAYHKoZI
zj0CAQYJKyQDAwIIAQEHA0IABJZQrG1NWxIB3kz/6Z2zojlkJqN3vJXZ3EZnJ6JXTXw5ZDFZ5Xjw
Wmtgfomv3VOV7qzI5ycUSJysMWDEu3mqRcajge0wgeowHQYDVR0OBBYEFJ8DVLAZWT+BlojTD4MT
/Na+ES8YMDgGCCsGAQUFBwEBBCwwKjAoBggrBgEFBQcwAYYcaHR0cDovL2VoY2EuZ2VtYXRpay5k
ZS9vY3NwLzAMBgNVHRMBAf8EAjAAMCEGA1UdIAQaMBgwCgYIKoIUAEwEgUswCgYIKoIUAEwEgSMw
HwYDVR0jBBgwFoAUKPD45qnId8xDRduartc6g6wOD6gwLQYFKyQIAwMEJDAiMCAwHjAcMBowDAwK
SURQLURpZW5zdDAKBggqghQATASCBDAOBgNVHQ8BAf8EBAMCB4AwCgYIKoZIzj0EAwIDRwAwRAIg
VBPhAwyX8HAVH0O0b3+VazpBAWkQNjkEVRkv+EYX1e8CIFdn4O+nivM+XVi9xiKK4dW1R7MD334O
pOPTFjeEhIVV&lt;/m2:X509Certificate&gt;
        &lt;/m:VerifyCertificate&gt;
    &lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Das zu prüfende Zertifikat in Base64-DER-Codierung ist mit <code>&lt;m2:X509Certificate&gt;&lt;/m2:X509Certificate&gt;</code> identifiziert.
</td>
</tr>
</table>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Response</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">HTTP/1.1 200 OK
Content-Type: text/xml;charset=utf-8
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;SOAP-ENV:Header/&gt;
    &lt;SOAP-ENV:Body&gt;
        &lt;ns4:VerifyCertificateResponse xmlns:ns2="http://ws.gematik.de/conn/ConnectorCommon/v5.0"
            xmlns:ns3="http://ws.gematik.de/tel/error/v2.0"
            xmlns:ns4="http://ws.gematik.de/conn/CertificateService/v6.0"&gt;
            &lt;ns2:Status&gt;
                &lt;ns2:Result&gt;OK&lt;/ns2:Result&gt;
            &lt;/ns2:Status&gt;
            &lt;ns4:VerificationStatus&gt;
                &lt;ns4:VerificationResult&gt;VALID&lt;/ns4:VerificationResult&gt;
                &lt;/ns4:VerificationStatus&gt;
                &lt;ns4:RoleList&gt;
                    &lt;ns4:Role&gt;1.2.276.0.76.4.260&lt;/ns4:Role&gt;
                &lt;/ns4:RoleList&gt;
            &lt;/ns4:VerifyCertificateResponse&gt;
        &lt;/SOAP-ENV:Body&gt;
    &lt;/SOAP-ENV:Envelope&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
In <code>&lt;ns4:VerificationResult&gt;&lt;/ns4:VerificationResult&gt;</code> wird das Prüfergebnis des Zertifikats [VALID = gültig, INCONCLUSIVE = offline-gültig ohne Sperrstatus, INVALID = ungültig] angegeben
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
in <code>&lt;ns4:Role&gt;VALID&lt;/&lt;ns4:Role&gt;</code> ist die technische Rolle hinterlegt, wie im Zertifikat angegeben.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Aufgrund der im Feld befindlichen unterschiedlichen Konnektorversionen ist ggfs. nicht in allen Installationen die aktuell gültige Liste der OIDs gemäß gemSpec_OID bekannt. Daher kann es vorkommen, dass einige Konnektorversionen die Zertifikate als ungültig betrachten. Die gematik arbeitet an einer Lösung, die Primärsystemen die Implementierung des PKI-Stacks in einer Übergangsphase erspart.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title=":heavy_exclamation_mark:"></i>
</td>
<td class="content">
Die Gültigkeitsprüfung von ECC-Zertifikaten unterstützt der Konnektor erst in der Version PTV4 ("ePA 1.0").
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="anchor-sign-challenge"><a class="anchor" href="#anchor-sign-challenge"></a>Signatur mit SMC-B erzeugen (external_authenticate)</h3>
<div class="paragraph">
<p>Das vom IDP bereitgestellte Challenge-Token muss mit der AUT-Identität der SMC-B signiert werden. Das Primärsystem berechnet den Hashwert der Challenge im vom IDP vorgegebenen SHA-256-Verfahren und ruft für diesen Hashwert die Konnektor-Operation <code>ExternalAuthenticate</code> auf.<br>
Für das obige Challenge-Beispiel ergibt sich der folgende SHA-256-Wert: <code>dd775a30757431a62bbe12301898511f5d9d5145a58dbd5d6cbae2481b36993f</code> in HEX-Darstellung, welcher dann Base64-codiert werden muss (ergibt <code>3XdaMHV0MaYrvhIwGJhRH12dUUWljb1dbLriSBs2mT8=</code>).</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">URI</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="https://192.168.x.y/Konnektorservice" class="bare">https://192.168.x.y/Konnektorservice</a></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Method</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>POST</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">HTTP Header</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>Content-Type: text/xml; charset=UTF-8
Content-Length: 1234
SOAPAction: "http://ws.gematik.de/conn/SignatureService/v7.4#ExternalAuthenticate"</pre>
</div>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Payload</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;soap-env:Envelope xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;soap-env:Body&gt;
        &lt;ns0:ExternalAuthenticate xmlns:ns0="http://ws.gematik.de/conn/SignatureService/v7.4"&gt;
            &lt;ns1:CardHandle xmlns:ns1="http://ws.gematik.de/conn/ConnectorCommon/v5.0"&gt;smc-b_2&lt;/ns1:CardHandle&gt;
            &lt;ns2:Context xmlns:ns2="http://ws.gematik.de/conn/ConnectorContext/v2.0"&gt;
                &lt;ns3:MandantId xmlns:ns3="http://ws.gematik.de/conn/ConnectorCommon/v5.0"&gt;Mandant1&lt;/ns3:MandantId&gt;
                &lt;ns4:ClientSystemId xmlns:ns4="http://ws.gematik.de/conn/ConnectorCommon/v5.0"&gt;myPVS&lt;/ns4:ClientSystemId&gt;
                &lt;ns5:WorkplaceId xmlns:ns5="http://ws.gematik.de/conn/ConnectorCommon/v5.0"&gt;WP1&lt;/ns5:WorkplaceId&gt;
            &lt;/ns2:Context&gt;
            &lt;ns0:BinaryString&gt;
                &lt;ns7:Base64Data xmlns:ns7="urn:oasis:names:tc:dss:1.0:core:schema"&gt;3XdaMHV0MaYrvhIwGJhRH12dUUWljb1dbLriSBs2mT8=&lt;/ns7:Base64Data&gt;
            &lt;/ns0:BinaryString&gt;
        &lt;/ns0:ExternalAuthenticate&gt;
    &lt;/soap-env:Body&gt;
&lt;/soap-env:Envelope&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Entsprechend der Mandantenkonfiguration wird in <code>&lt;ns1:CardHandle&gt;&lt;/ns1:CardHandle&gt;</code> die SMC-B referenziert, welche der IDP authentifizieren soll.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
In <code>&lt;ns7:Base64Data&gt;&lt;/ns7:Base64Data&gt;</code> befindet sich der zu signierende Hashwert zur Challenge (Base64-Darstellung des Challengetoken, das zuvor vom IDP bezogen wurde).
</td>
</tr>
</table>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Response</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">HTTP/1.1 200 OK
Content-Type: text/xml;charset=utf-8
&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
    &lt;soap:Body&gt;
        &lt;ns4:ExternalAuthenticateResponse xmlns="http://ws.gematik.de/conn/ConnectorCommon/v5.0"
            xmlns:ns2="http://ws.gematik.de/conn/ConnectorContext/v2.0"
            xmlns:ns3="urn:oasis:names:tc:dss:1.0:core:schema"
            xmlns:ns4="http://ws.gematik.de/conn/SignatureService/v7.4"
            xmlns:ns5="http://www.w3.org/2000/09/xmldsig#"
            xmlns:ns6="http://ws.gematik.de/tel/error/v2.0"
            xmlns:ns7="http://uri.etsi.org/01903/v1.3.2#"
            xmlns:ns8="http://ws.gematik.de/conn/CertificateServiceCommon/v2.0"
            xmlns:ns9="urn:oasis:names:tc:SAML:1.0:assertion"
            xmlns:ns10="http://www.w3.org/2001/04/xmlenc#"
            xmlns:ns11="http://uri.etsi.org/02231/v2#"
            xmlns:ns12="urn:oasis:names:tc:dss-x:1.0:profiles:verificationreport:schema#"
            xmlns:ns13="urn:oasis:names:tc:dss-x:1.0:profiles:SignaturePolicy:schema#"
            xmlns:ns14="urn:oasis:names:tc:SAML:2.0:assertion"&gt;
            &lt;Status&gt;
                &lt;Result&gt;OK&lt;/Result&gt;
            &lt;/Status&gt;
            &lt;ns3:SignatureObject&gt;
                &lt;ns3:Base64Signature Type="urn:ietf:rfc:3447"&gt;iSCNtUJUaH3uameymaYdplnmn5iq6k90a8i/TvSRvYOjw3x7zXn6+74LoVDc1xWNplmy6fzZejoIZAPxAJ0wBGQWFbdpD6ZLdOqC+Cm3BXUEXHeW2swfI6KfUwfWj43pujBTdzYI6JYG08sL63fxuY9eeGndzuWCDvHQVK0bPPjxq0K/fHx+PFQ1DxuNr5jbDaCBKOegPvcPXOFBY8dRGW0fu/T8baEpm5ACNGmX3vIqC3SWsP7M1TcTbEwxh82vMc0iOkIVDa2LKJAk5H4gSBBAGJahsFD3N3fnKgdLr81HiEQaoIyb+uEIVvaemz8yQ59dAIv3Hrb0Em5k/faHDQ==&lt;/ns3:Base64Signature&gt;
            &lt;/ns3:SignatureObject&gt;
        &lt;/ns4:ExternalAuthenticateResponse&gt;
    &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Code</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Type Success</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>200</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>OK<br>
<span class="small">Die Anfrage wurde erfolgreich bearbeitet. Die angeforderte Ressource wurde vor dem Senden der Antwort erstellt.</span></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Code</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Type Error</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>400</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Bad Request <br>
<span class="small">Die Anfrage-Nachricht war fehlerhaft aufgebaut.</span></p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
<code>&lt;ns3:Base64Signature&gt;&lt;/ns3:Base64Signature&gt;</code> enthält die Signatur, die mittels Konnektor und dem privaten Schlüssel der SMC-B erstellt wurde.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
<strong>Nutzung der Gesundheitskarte</strong><br>
Versicherte weisen sich gegenüber der Telematikinfrastruktur mit der Identität der elektronischen Gesundheitskarte aus.
Der Ablauf ist analog zu dem oben ausgeführt Ablauf für Primärsysteme. Das E-Rezept-FdV bündelt dabei (wie das Primärsystem) in Stufe 1 die E-Rezept-Fachlogik und die Funktion des Authenticator-Moduls. Die Signatur der Challenge erfolgt bei Nutzung der elektronischen Gesundheitskarte bspw. über die NFC-Schnittstelle des Mobilgeräts.
Dabei wird das Schlüsselmaterial PRK.CH.AUT für Private-Key und C.CH.AUT für das Zertifikat inkl. PublicKey verwendet.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="anchor-vau-transport"><a class="anchor" href="#anchor-vau-transport"></a>Verschlüsselter Transportkanal zur Vertrauenswürdigen Ausführungsumgebung ("VAU-Transport")</h3>
<div class="paragraph">
<p>Der Einsatz moderner Transportverschlüsselung ab TLS 1.2 schützt vor der Einsicht sensibler Daten beim Transport über das Internet. Dabei sind sowohl die Daten des HTTP-Body als auch die aufgerufene URL und die HTTP-Header verschlüsselt. In modernen Cloud-Infrastrukturen enden solche TLS-Verbindungen meist an einem Internetgateway, müssen jedoch in einer Serverinfrastruktur häufig zu dahinterliegenden Applicationservern und -diensten weitertransportiert werden.</p>
</div>
<div class="paragraph">
<p>Um sensible Daten bis hinein in einen vertrauenswürdigen Ausführungskontext verschlüsselt zu transportieren, erfolgt der Zugang zum E-Rezept-Fachdienst mit einer zusätzlichen Transportverschlüsselung für eine kryptografische Identität der vertrauenswürdigen Ausführungsumgebung (VAU). Dabei werden die Daten des HTTP-Body für den Verarbeitungskontext der VAU  um einen symmetrischen Antwortschlüssel ergänzt und anschließend asymmetrisch verschlüsselt. Dieser verschlüsselte HTTP-Request wird dann mittels TLS transportverschlüsselt an den E-Rezept-Fachdienst übergeben.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/api_vau_transport.png" alt="api vau transport" width="80%"></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Das Diagramm inkl. der konkreten Ablaufbeschreibung befindet sich auch im Spezifikationsdokument [gemSpec_Krypt] in Kapitel 7.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">In den folgenden github-Repositories finden sich Beispiel-Implementierungen für die verschlüsselte VAU-Kommunikation</div>
<ul>
<li>
<p><a href="https://github.com/gematik/ref-erp-client-cs/" class="bare">https://github.com/gematik/ref-erp-client-cs/</a></p>
</li>
<li>
<p><a href="https://github.com/ere-health/architecture" class="bare">https://github.com/ere-health/architecture</a></p>
</li>
<li>
<p><a href="https://github.com/ere-health/ere-ps-app" class="bare">https://github.com/ere-health/ere-ps-app</a></p>
</li>
<li>
<p><a href="https://github.com/ere-health/front-end-ere.health" class="bare">https://github.com/ere-health/front-end-ere.health</a></p>
</li>
<li>
<p><a href="https://bitbucket.org/andreas_hallof/vau-protokoll/src/master/erp" class="bare">https://bitbucket.org/andreas_hallof/vau-protokoll/src/master/erp</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Die VAU des E-Rezept-Fachdienstes erzeugt eine HTTP-Response entsprechend des Workflows im E-Rezept und verschlüsselt diese Response symmetrisch mit dem vom Client bereitgestellten Antwortschlüssel. Die verschlüsselte Response wird anschließend mittels TLS transportverschlüsselt an den Client zurückgegeben.</p>
</div>
<div class="paragraph">
<p>Ein zusätzlich in den Aufrufen vom E-Rezept-Fachdienst generiertes, wechselndes Nutzerpseudonym wirkt zusätzlich Überlastungsangriffen entgegen, indem Aufrufe ohne Nutzerpseudonym mit einer geringeren Priorität bearbeitet werden.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title=":fire:"></i>
</td>
<td class="content">
Die zusätzliche Verschlüsselung erfolgt mit dem AES-GCM-Verfahren, die über ein AuthenticationTag am Ende des Bitstroms die Integrität des transportierten Ciphertextes sicherstellt. Der AES-Schlüssel ergibt sich zufällig aus der Ableitung über den öffentlichen ECC-Schlüssel des VAU-ENC-Zertifikats. Sind der verwendete <strong>Random</strong> oder die <strong>X</strong>- und <strong>Y</strong>-Koordinaten des ECC-Schlüssels dabei nicht exakt 32 Byte groß, werden die Daten zwar korrekt verschlüsselt, aber das AuthenticationTag passt am Ende nicht zum Ciphertext - der Fachdienst muss das dann gemäß AES-Spezifikation als "manipuliert" ablehnen und antwortet mit einer Fehlermeldung <code>vau decryption failed: AesGcmException can&#8217;t finalize AES-GCM decryption;</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Die folgenden beispielhaften Code-Zeilen prüfen auf eine exakte Länge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">//sharedSecretBytes muss 32 Byte groß sein entweder vorn abschneiden oder mit 0 auffüllen
if (sharedSecretBytes.Length &gt; 32) {
    sharedSecretBytes = sharedSecretBytes.Skip(sharedSecretBytes.Length - 32).ToArray();
} else if (sharedSecretBytes.Length &lt; 32) {
    sharedSecretBytes = Enumerable.Repeat((byte) 0, 32 -
      sharedSecretBytes.Length).Concat(sharedSecretBytes).ToArray();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ein Java-Beispiel stellen wir in der folgenden Datei  <a href="../samples/snippets/VAUClientCrypto.java" target="_blank" rel="noopener">VAUClientCrypto.java</a> bereit, in der dieses Problem mit der Methode <code>pad32(byte[] input)</code> behandelt wird.</p>
</div>
<div class="sect3">
<h4 id="_kennzeichnung_des_verschlüsselten_inhalts_für_routing"><a class="anchor" href="#_kennzeichnung_des_verschlüsselten_inhalts_für_routing"></a>Kennzeichnung des verschlüsselten Inhalts für Routing</h4>
<div class="paragraph">
<p>Der E-Rezept-Fachdienst benötigt eine Kennzeichnung im äußeren http-Request, um den verschlüsselten Inhalt an den fachlich zuständigen VAU-Kontext zu routen. Um eine Überlastung nutzerrollen- und workflowspezifischer VAU-Kontexte zu vermeiden, werden die http-Header <code>X-erp-user</code> und <code>X-erp-resource</code> genutzt. Die folgende Tabelle zeigt die Belegung der Header zur Nutzung durch die entsprechenden E-Rezept-Nutzer (in den Beispielen der verschiedenen UseCases sind die jeweiligen Header-Belegungen für den äußeren http-Request angegeben):</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Leistungserbringer (PVS, AVS ,KIS)</strong></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Versicherte (E-Rezept-App)</strong></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>X-erp-user: l</code><br>
Dieser Header mit Wert "l" (kleines "L") signalisiert dem E-Rezept-Fachdienst einen Zugriff durch Leistungserbringer</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>X-erp-user: v</code><br>
Dieser Header mit Wert "v" (kleines "V") signalisiert dem E-Rezept-Fachdienst einen Zugriff durch Versicherte</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>X-erp-resource: Task</code><br>
<code>X-erp-resource: Communication</code><br>
Der Header mit diesem Wert signalisiert den Zugriff auf eine bestimmte FHIR-Ressource, z.B. Task. Es wird immer nur eine Ressource genannt, da Zugriffe auch immer nur an eine Ressource adressiert werden.
Hinweis: Beim Zugriff auf das CapabilityStatement mit GET /metadata wird entsprechend <code>X-erp-resource: metadata</code> angegeben. Die Auswertung erfolgt <strong>Case-Sensitiv</strong></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>X-erp-resource: Task</code><br>
<code>X-erp-resource: MedicationDispense</code><br>
<code>X-erp-resource: Communication</code><br>
<code>X-erp-resource: AuditEvent</code></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verbindungsaufbau_zum_e_rezept_fachdienst"><a class="anchor" href="#_verbindungsaufbau_zum_e_rezept_fachdienst"></a>Verbindungsaufbau zum E-Rezept-Fachdienst</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Zunächst muss das Verschlüsselungszertifikat der VAU vom E-Rezept-Fachdienst abgerufen werden.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">URI</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="https://erp.zentral.erp.splitdns.ti-dienste.de/VAUCertificate" class="bare">https://erp.zentral.erp.splitdns.ti-dienste.de/VAUCertificate</a></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Method</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>GET</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">HTTP Header</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>X-erp-user: l</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Der Header <code>X-erp-user</code> signalisiert dem E-Rezept-Fachdienst einen Zugriff aus der Leistungserbringerumgebung [<code>l</code> - kleines "L"] (muss in jedem Header angegeben werden).
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Payload</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Response</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">HTTP/1.1 200 OK
Content-Type: application/pkix-cert

1100110001111111000000011011000010100111100001111000010010111001...</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Der E-Rezept-Fachdienst stellt zusätzlich eine frische OCSP-Response für die erweiterte Prüfung des Verschlüsselungszertifikats bereit.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">URI</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="https://erp.zentral.erp.splitdns.ti-dienste.de/VAUCertificateOCSPResponse" class="bare">https://erp.zentral.erp.splitdns.ti-dienste.de/VAUCertificateOCSPResponse</a></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Method</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>GET</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">HTTP Header</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>X-erp-user: l</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Der Header <code>X-erp-user</code> signalisiert dem E-Rezept-Fachdienst einen Zugriff aus der Leistungserbringerumgebung [<code>l</code> - kleines "L"] (muss in jedem Header angegeben werden).
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Payload</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Response</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">HTTP/1.1 200 OK
Content-Type: application/ocsp-response

100100100110001011110001110111011000110000101111101100100111011...</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_request_versenden"><a class="anchor" href="#_request_versenden"></a>Request versenden</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Für den verschlüsselten VAU-Transport wird der zu transportierende HTTP-Request für die VAU in mehreren Schritten aufbereitet. Als Beispiel wird im Folgenden die Abfrage aller E-Rezepte eines Versicherten verwendet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">GET /Task HTTP/1.1
Host: erp.zentral.erp.splitdns.ti-dienste.de
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
User-Agent: E-Rezept FdV 1.0.0
Accept: application/fhir+json;charset=utf-8</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title=":heavy_exclamation_mark:"></i>
</td>
<td class="content">
Der zu verschlüsselnde http-Request muss vollständig und syntaktisch korrekt gemäß <a href="https://datatracker.ietf.org/doc/html/rfc2616">RFC-2616</a> erstellt werden (d.h. inkl. aller verpflichtenden http-Header und ggfs. http-Body 'new line'-getrennt).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Zunächst müssen im Client eine zufällige Request-ID (z.B. <code>b69f01734f34376ddcdbdbe9af18a06f</code>) und ein symmetrischer Antwortschlüssel (z.B. <code>16bac90134c635e4ec85fae0e4885d9f</code>) generiert werden.<br>
Als nächstes wird die folgende leerzeichengetrennte Zeichenkette <code>p</code> für die anschließende Verschlüsselung gebildet: <code>p="1" + " " + ACCESS_TOKEN + " " + Request-ID + " " + Antwortschlüssel + " " + HTTP-Request</code>, mit obigem Beispiel ergibt sich für <code>p</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"1 eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J b69f01734f34376ddcdbdbe9af18a06f 16bac90134c635e4ec85fae0e4885d9f GET /Task HTTP/1.1
Host: erp.zentral.erp.splitdns.ti-dienste.de
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
User-Agent: E-Rezept FdV 1.0.0
Accept: application/fhir+json;charset=utf-8"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Diese Zeichenkette wird nun mit dem ECIES-Verfahrens [SEC1-2009] und dem öffentlichen Schlüssel aus dem zuvor abgerufenen Verschlüsselungszertifikat der VAU hybrid verschlüsselt. Sei <code>1101110011011110000101101000111000010101100110111011111100011111111110001101110010011010010110000101000001011000000100</code> ein unvollständiges Beispiel für das Ergebnis der Verschlüsselungsoperation. Dieses wird nun als Payload im HTTP-Body des folgenden Requests an den E-Rezept-Fachdienst übergeben.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">URI</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a href="https://erp.zentral.erp.splitdns.ti-dienste.de/VAU/0" class="bare">https://erp.zentral.erp.splitdns.ti-dienste.de/VAU/0</a></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Method</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>POST</p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">HTTP Header</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Content-Type: application/octet-stream</code><br>
X-erp-user: l</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Der Header <code>X-erp-user</code> signalisiert dem E-Rezept-Fachdienst einen Zugriff aus der Leistungserbringerumgebung [<code>l</code> - kleines "L"] (muss in jedem Header angegeben werden).
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">HTTP Body</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>1101110011011110000101101000111000010101100110111011111100011111111110001101110010011010010110000101000001011000000100</code></p>
</div></div></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Response</p></th>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">HTTP/1.1 200 OK
Content-Type: application/octet-stream
Userpseudonym: 5a049a2c1654e685247e2d20136445d9-632f841a029564ce000f29675d192513

001111101111100110001001001111010110010010111110101100100011110...</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Die <code>0</code> am Ende der URL des Requests steht für ein (dem Client nicht bekanntes) Nutzerpseudonym, nach der ersten Antwort der VAU des E-Rezept-Fachdienstes kann das vom Fachdienst mitgeteilte <code>Userpseudonym</code> <code>5a049a2c1654e685247e2d20136445d9-632f841a029564ce000f29675d192513</code> anstelle der <code>0</code> verwendet werden, um Folgezugriffe höher zu priorisieren.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_response_verarbeiten"><a class="anchor" href="#_response_verarbeiten"></a>Response verarbeiten</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nach dem erfolgreichen Abschluss der Bearbeitung des Requests durch die VAU des E-Rezept-Fachdienstes erhält der Client die verschlüsselte HTTP-Response der VAU in einer äußeren "VAU-Transport"-HTTP-Response.
Der HTTP-Statuscode 200 signalisiert dabei die korrekte Verarbeitung und Erstellung der verschlüsselten Antwort. Die innere HTTP-Response des fachlichen Ergebnisses aus der VAU kann dabei einen abweichenden HTTP-Statuscode beinhalten, wenn aufgrund der Daten oder Verarbeitung innerhalb der VAU Fehlerzustände eintreten oder ungültige Daten übergeben wurden. Sei <code>001111101111100110001001001111010110010010111110101100100011110&#8230;&#8203;</code> die verschlüsselte Response zum obigen Beispiel. Die Entschlüsselung mit dem für den Request generierten Antwortschlüssel `16bac90134c635e4ec85fae0e4885d9f`mittels AES-GCM liefert die innere HTTP-Response der VAU als leerzeichengetrennte Zeichenkette:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">1 b69f01734f34376ddcdbdbe9af18a06f HTTP/1.1 200 OK
Content-Type: application/fhir+json;charset=utf-8
Content-Location: https://erp.zentral.erp.splitdns.ti-dienste.de/Bundle/f5ba6eaf-9052-42f6-ac4e-fadceed7293b

{
  "resourceType": "Bundle",
  "id": "f5ba6eaf-9052-42f6-ac4e-fadceed7293b",
  "meta": {
    "lastUpdated": "2020-03-01T07:02:37.836+00:00"
  },
  "type": "searchset",
  "total": 2,
  "link": [{
    "relation": "self",
    "url": "https://erp.zentral.erp.splitdns.ti-dienste.de/Task/"
  }],
  "entry": [{
    "fullUrl": "https://erp.zentral.erp.splitdns.ti-dienste.de/Task/160.123.456.789.123.58",
    "resource": {
      "resourceType": "Task",
      "id":"160.123.456.789.123.58",
      "meta": {
        "profile":  [
            "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_PR_Task"
        ]
      },
      "extension":  [{
        "url": "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_EX_PrescriptionType",
        "valueCoding": {
          "system": "https://gematik.de/fhir/erp/CodeSystem/GEM_ERP_CS_FlowType",
          "code": "160",
          "display": "Muster 16 (Apothekenpflichtige Arzneimittel)"
        }
      }, {
        "url": "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_EX_AcceptDate",
        "valueDateTime": "2020-03-02T08:25:05+00:00"
      }, {
        "url": "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_EX_ExpiryDate",
        "valueDateTime": "2020-05-02T08:25:05+00:00"
      }],
      "identifier":  [{
        "system": "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_NS_PrescriptionId",
        "value": "160.123.456.789.123.58"
      }, {
        "system": "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_NS_AccessCode",
        "value": "777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"
      }, {
        "system": "https://gematik.de/fhir/erp/StructureDefinition/GEM_ERP_NS_Secret",
        "value": "c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf"
      }],
      "status": "in-progress",
      "intent": "order",
      "for": {
        "identifier": {
          "system": "http://fhir.de/sid/gkv/kvid-10",
          "value": "X123456789"
        }
      },
      "authoredOn": "2020-03-02T08:25:05+00:00",
      "lastModified": "2020-03-02T08:45:05+00:00",
      "performerType":  [{
        "coding":  [{
          "system": "urn:ietf:rfc:3986",
          "code": "urn:oid:1.2.276.0.76.4.54",
          "display": "Öffentliche Apotheke"
        }]
      }],
      "input":  [{
        "type": {
          "coding":  [{
            "system": "https://gematik.de/fhir/erp/CodeSystem/GEM_ERP_CS_DocumentType",
            "code": "1",
            "display": "Health Care Provider Prescription"
          }]
        },
        "valueReference": {
          "reference": "Bundle/KbvPrescriptionExample"
        }
      }]
    },
    "search": {
      "mode": "match"
    }
  }]
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title=":information_source:"></i>
</td>
<td class="content">
Die innere HTTP-Response hat die folgende Struktur "1" + " " + ursprüngliche-Request-ID + " " + Response-Header-und-Body
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title=":warning:"></i>
</td>
<td class="content">
Ein Splitten der inneren Struktur anhand des Leerzeichens " " könnte dazu führen, dass auch der Payload im inneren HTTP-Response-Body zerstückelt wird. Robuster ist das Prüfen auf Vorhandensein der ursprünglichen Request-ID und anschließendes Entfernen des von der VAU hinzugefügten Präfixes <code>"1" + " " + ursprüngliche-Request-ID + " "</code>. Nun kann die innere HTTP-Response standardgemäß weiterverarbeitet werden.
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright &copy; <script>document.write(new Date().getFullYear())</script> gematik GmbH</p>
  <p>Generated using Antora and Asciidoc.</p>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
